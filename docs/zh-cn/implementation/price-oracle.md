# 价格预言机
为了使Futarchy正常工作，您需要一种提取提案条件市场价格的方法。

初级的方法是在提案最后确定时直接使用现货价格。但这是极易被操纵的。例如，有人可能在最后确定之前抬高通过市场的价格，以强制通过提案。

<figure><img src="../.gitbook/assets/conditional-markets-dark.png" alt=""><figcaption><p>有人可能在最后一分钟内抬高通行价格，以强制通过提案</p></figcaption></figure>

### TWAP（时间加权平均价格）
较为精明的做法是使用时间加权平均价格（TWAP）。TWAP更难以被操纵。例如，如果TOKEN的通过价格在提案的前72小时为100美元，然后操纵者在最后15分钟将价格推高到1000美元，那么TWAP将为103.11美元，与'真实价格'只有3%的差距。

然而，TWAPs也有其缺陷。重要的是，Solana验证者可以通过在几个时段内将价格设定得极高来操纵TWAPs。由于验证者控制着时段，他们知道没有人能够在他们的高价中卖出。如果一个验证者控制了1%的时段，他们可以通过在他们的时段内将通过价格提高100倍来强制通过一个提案。

### 滞后价格TWAP
我们通过使用我们称之为滞后价格TWAP的特殊形式来处理这个问题。在滞后价格TWAP中，输入到TWAP的数字并不是原始价格 - 它是一个试图近似价格的数字，但每次更新只能移动一定的数量。我们称之为“观察”。每个DAO必须配置用于其提案市场的“首次观察”和“每次更新的最大观察变化”。

<figure><img src="../.gitbook/assets/twap-chart.png" alt=""><figcaption></figcaption></figure>

举个例子，假设MetaDAO的首次观察设定为500美元，每次更新的最大变动为5美元。如果一个提案以550美元的通过市场开启，那么需要10次更新才能准确反映价格。假设每次更新间隔均匀，价格保持在550美元，那么10次更新后的TWAP将是527.5美元（\[505美元 + 510美元 + 515美元 + 520美元 + 525美元 + 530美元 + 535美元 + 540美元 + 545美元 + 550美元] / 10）。再经过10次更新，它将是538.75美元。

### 更新之间的一分钟
理想情况下，TWAP对正常价格变动应高度敏感，对操纵价格变动应高度不敏感。我们最初允许每个时段更新一次，但这会产生相反的效果：攻击者可能能够在每个时段中占据一席之地，而正常的交易活动并不那么频繁（至少现在还不是！），所以攻击者会比真实的价格变动更能影响价格。为了应对这个问题，我们只允许每分钟更新一次。
